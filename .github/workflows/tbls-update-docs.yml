name: Update Database Documentation

on:
  push:
    branches:
      - develop
    paths:
      - 'src/database/migrations/**'
  pull_request:
    branches:
      - develop
    paths:
      - 'src/database/migrations/**'

jobs:
  update-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: develop
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo_mysql, mysql

      - name: Install MySQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client

      - name: Setup tbls
        uses: k1low/setup-tbls@v1

      - name: Setup Laravel project
        working-directory: ./src
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader
          cp .env.local .env
          php artisan key:generate

      - name: Configure database connection
        working-directory: ./src
        run: |
          # .envãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šã‚’è¿½åŠ 
          echo "DB_CONNECTION=mysql" >> .env
          echo "DB_HOST=127.0.0.1" >> .env
          echo "DB_PORT=3306" >> .env
          echo "DB_DATABASE=laravel" >> .env
          echo "DB_USERNAME=root" >> .env
          echo "DB_PASSWORD=password" >> .env
          echo "APP_ENV=testing" >> .env

      - name: Verify tbls configuration
        working-directory: ./src
        run: |
          echo "Checking tbls.yml configuration..."
          if [ -f "tbls.yml" ]; then
            echo "tbls.yml found"
            cat tbls.yml
          else
            echo "tbls.yml not found"
            exit 1
          fi

      - name: Start MySQL container
        run: |
          docker run --name mysql-temp -e MYSQL_ROOT_PASSWORD=password -e MYSQL_DATABASE=laravel -p 3306:3306 -d mysql:8.0
          echo "Waiting for MySQL to be ready..."
          sleep 30
          
          # MySQLã®èµ·å‹•ç¢ºèª
          for i in {1..10}; do
            if mysql -h 127.0.0.1 -P 3306 -u root -ppassword -e "SELECT 1;" >/dev/null 2>&1; then
              echo "MySQL is ready"
              break
            else
              echo "Waiting for MySQL... (attempt $i/10)"
              sleep 10
            fi
          done

      - name: Run migrations
        working-directory: ./src
        run: |
          echo "Running Laravel migrations..."
          php artisan migrate --force
          echo "Migrations completed"
          
          # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª
          echo "Tables after migration:"
          mysql -h 127.0.0.1 -P 3306 -u root -ppassword laravel -e "SHOW TABLES;"

      - name: Generate documentation
        working-directory: ./src
        run: |
          mkdir -p ../docs
          echo "Generating database documentation..."
          
          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª
          echo "Checking database connection..."
          mysql -h 127.0.0.1 -P 3306 -u root -ppassword -e "SHOW DATABASES;"
          
          # ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç¢ºèª
          echo "Checking tables..."
          mysql -h 127.0.0.1 -P 3306 -u root -ppassword laravel -e "SHOW TABLES;"
          
          # tblsã®è¨­å®šç¢ºèª
          echo "Checking tbls configuration..."
          tbls lint
          
          # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
          echo "Generating documentation with tbls..."
          tbls doc
          
          echo "Documentation generated successfully"
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo "Generated files:"
          ls -la ../docs/
          
          # ERå›³ã®ç¢ºèª
          if [ -f "../docs/er.svg" ]; then
            echo "ER diagram generated: ../docs/er.svg"
          elif [ -f "../docs/schema.svg" ]; then
            echo "ER diagram generated: ../docs/schema.svg"
          else
            echo "ER diagram not generated"
          fi
          
          if [ -f "../docs/tables.md" ]; then
            echo "Tables documentation generated: ../docs/tables.md"
          elif [ -f "../docs/README.md" ]; then
            echo "Tables documentation generated: ../docs/README.md"
          else
            echo "Tables documentation not generated"
          fi

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for changes
        id: check_changes
        run: |
          # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
          if [ ! -d "docs" ]; then
            echo "docs directory not found"
            echo "changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # å¤‰æ›´ã®ç¢ºèª
          git add docs/
          if git diff --cached --quiet; then
            echo "No changes detected in docs directory"
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in docs directory"
            echo "Changed files:"
            git diff --cached --name-only
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Debug PR creation
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          echo "=== Debug Information ==="
          echo "Event name: ${{ github.event_name }}"
          echo "Current ref: ${{ github.ref }}"
          echo "Current ref name: ${{ github.ref_name }}"
          echo "Head ref: ${{ github.head_ref }}"
          echo "Base ref: ${{ github.base_ref }}"
          echo "Changes detected: ${{ steps.check_changes.outputs.changes }}"
          echo "Token available: ${{ secrets.GITHUB_TOKEN != '' }}"
          echo "========================"

      - name: Create Pull Request
        if: steps.check_changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: tblsã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°"
          title: "ğŸ¤– ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–° (å®Ÿè¡Œ #${{ github.run_number }})"
          body: |
            ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

            ã“ã®PRã¯ã€æœ€è¿‘ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ›´ã«åŸºã¥ã„ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã™ã€‚

            å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã—ã€å•é¡ŒãŒãªã‘ã‚Œã°ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚

            ### å¤‰æ›´å†…å®¹:
            - ERå›³ã®æ›´æ–°
            - ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã®æ›´æ–°

            ### ä½¿ç”¨ãƒ„ãƒ¼ãƒ«:
            - [tbls](https://github.com/k1low/tbls)

          # developãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ™ãƒ¼ã‚¹ã«è¨­å®š
          base: develop
          branch: update-database-docs
          delete-branch: true
          committer: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>

      - name: Output PR info
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          echo "Pull request created successfully"
          echo "Branch: update-database-docs"
          echo "Base: develop"
          echo "Target: develop â† update-database-docs"

      - name: Cleanup
        if: always()
        run: |
          docker stop mysql-temp || true
          docker rm mysql-temp || true

      - name: Success message
        if: success()
        run: |
          echo "Database documentation workflow completed successfully"
          echo "ER diagram and table definitions have been updated"
          if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "Pull request has been created for review"
          else
            echo "No changes detected in documentation"
          fi

      - name: Failure message
        if: failure()
        run: |
          echo "Workflow failed"
          echo "Check the logs above for detailed error information"
          echo "Common issues:"
          echo "- Token permissions"
          echo "- Repository settings"
          echo "- Network connectivity"
          echo "- Branch protection rules"
